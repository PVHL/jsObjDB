"use strict";var is_node=typeof module!=="undefined"&&module.exports;if(is_node){var _=require("../lib/lo-dash.min.js")}var Cursor=function(e,t){this.db=e;if(t){var n=t.length;for(var r=0;r<n;r++){this.push(t[r])}}};Cursor.prototype=new Array;Cursor.prototype.sizeof=function(){return this.length*8+8};Cursor.prototype.toString=function(){return"Cursor("+this.length+" items)"};Cursor.prototype._sort=Cursor.prototype.sort;Cursor.prototype.sort=function(e,t){if(typeof e!=="string"){throw"Property name must be provided for sorting"}t=t===undefined?true:t;this._sort(function(n,r){var i=jsObjDB.getPropertyValue(n,e);var s=jsObjDB.getPropertyValue(r,e);var o;if(i<s){o=-1}else if(i>s){o=1}else{o=0}if(!t){return-o}return o});return this};Cursor.prototype.first=function(){if(this.length>0){return this[0]}else{return null}};Cursor.prototype.last=function(){if(this.length>0){return this[this.length-1]}else{return null}};Cursor.prototype.nth=function(e){if(e<this.length){return this[e]}else{return null}};Cursor.prototype.exists=function(e){return this.filter(e).length>0};Cursor.prototype.uniq=function(e){if(typeof e!=="string"){throw"A property name must be provided to uniq"}var t=_.uniq(this,function(t){return jsObjDB.getPropertyValue(t,e)});return new Cursor(this.db,t)};Cursor.prototype.each=function(e,t){t=t||this;_.each(this,e,t);return this};Cursor.prototype.async_each=function(e,t){t=t||this;var n=_.bind(e,t);_.each(this,function(e){setTimeout(function(){n(e)},0)},this);return this};Cursor.prototype.call=function(e,t){t=t||this;var n=_.bind(e,t);n(this);return this};Cursor.prototype.async_call=function(e,t){t=t||this;var n=_.bind(e,t);setTimeout(function(){n(this)},0);return this};Cursor.prototype.filter=function(e){var t=jsObjDB.parseQuery(e);return new Cursor(this.db,_.filter(this,function(e){return jsObjDB.doQueryMatching(e,t)}))};Cursor.prototype.filterWhere=function(e,t){if(!e){throw"Test function is required"}t=t||this;var n=_.bind(e,t);var r=new Cursor(this.db,_.filter(this,n));return r};Cursor.prototype.join=function(e,t,n,r){var i=_.reduce(this,function(i,s){n=n||"$eq";r=r||t;var o={};var u={};u[n]=jsObjDB.getPropertyValue(s,r);o[t]=u;var a=e.find(o);_.each(a,function(e){var t={};_.extend(t,e);_.extend(t,s);i.push(t)});return i},new Cursor(this.db),this);return i};Cursor.prototype.delete=function(){this.db.delete({_id:{$in:_.pluck(this,"_id")}});this.db=null;return this};Cursor.prototype.update=function(e){if(!this.db){throw"Cursor not attached to DB. Cannot be updated"}for(var t=0;t<this.length;t++){var n=this[t];this.db.update({_id:n._id},e)}return this};Cursor.prototype.indexOf=function(e){var t=jsObjDB.parseQuery(e);var n=this.length;for(var r=0;r<n;r++){var i=this[r];if(jsObjDB.doQueryMatching(i,t)){return r}}return-1};var ObjIndex=function(e,t,n){if(typeof e!=="string"){throw"Property name must be provided and be a string"}this.unique=t===undefined?false:t;this.required=n===undefined?false:n;this.property=e;this.values={};this.partitions=0};ObjIndex.prototype.toJSON=function(){return JSON.stringify({unique:this.unique,required:this.required,property:this.property})};ObjIndex.prototype.toString=function(){return"ObjIndex(property:"+this.property+", unique:"+this.unique+", partitions:"+this.partitions+")"};ObjIndex.prototype.sizeof=function(){var e=0;e+=2*3+2*this.property.length+8;_.forOwn(this.values,function(t,n){switch(typeof n){case"boolean":e+=4;break;case"number":e+=8;break;case"string":e+=2*n.length;break}e+=t.length*8},this);return e};ObjIndex.prototype.addItem=function(e){var t=jsObjDB.getPropertyValue(e,this.property);if(t===undefined){if(this.required){throw"Key "+this.property+" is required (and is missing)"}return}if(_.isArray(t)){var n=t.length;try{for(var r=0;r<n;r++){this._addItemValue(e,t[r])}}catch(i){this._removeItemValue(e,t[r]);throw i}}else{this._addItemValue(e,t)}};ObjIndex.prototype.addItems=function(e){_.each(e,function(e){this.addItem(e)},this)};ObjIndex.prototype._addItemValue=function(e,t){if(!_.has(this.values,t)){this.values[t]=[];this.partitions++}if(this.unique&&this.values[t].length>0){throw"Duplicate item on index ("+this.property+")"}this.values[t].push(e)};ObjIndex.prototype.removeItem=function(e){var t=jsObjDB.getPropertyValue(e,this.property);if(t===undefined){return}if(_.isArray(t)){var n=t.length;for(var r=0;r<n;r++){try{this._removeItemValue(e,t[r])}catch(i){}}}else{this._removeItemValue(e,t)}};ObjIndex.prototype.removeItems=function(e){_.each(e,function(e){this.removeItem(e)},this)};ObjIndex.prototype._removeItemValue=function(e,t){if(!_.has(this.values,t)){return}_.remove(this.values[t],function(t){return t._id===e._id});if(this.values[t].length===0){delete this.values[t];this.partitions--}};ObjIndex.prototype.find=function(e){if(!_.has(this.values,e)){return null}return this.values[e]};var jsObjDB=function(e,t){this.async=t===undefined?false:t;this.prim_key=e;this.store={};this.indexes={};this.ref_id=0;this._count=0;this.delegates=[];if(this.prim_key){this.addIndex(this.prim_key,true,true)}};jsObjDB.prototype.persist=function(e){if(typeof localStorage==="undefined"){throw"Local storage not supported in this browser"}localStorage[e]=this.toJSON()};jsObjDB.prototype.load=function(e){var t=localStorage[e];return this.loadFromJSON(t)};jsObjDB.prototype.loadFromJSON=function(e){var t=JSON.parse(e);this.prim_key=t.prim_key;this.async=t.async;this.indexes={};this.ref_id=0;this.store={};_.each(t.indexes,function(e){this.addIndex(e.property,e.unique,e.required)},this);_.each(t.data,function(e){delete e._id});this.insert(t.data);return this};jsObjDB.prototype.toJSON=function(){var e={async:this.async,prim_key:this.prim_key};e.indexes=[];e.indexes=_.map(this.indexes,function(e){return{unique:e.unique,required:e.required,property:e.property}});e.data=_.values(this.store);return JSON.stringify(e)};jsObjDB.prototype.sizeof=function(){var e=0;e+=2*1+(this.prim_key?2*this.prim_key.length:0)+8*2;e+=_.reduce(this.indexes,function(e,t){return e+t.sizeof()},0);e+=this._count*8;e+=_.reduce(this.store,function(e,t){return e+jsObjDB.sizeOfObject(t)},0);return e};jsObjDB.prototype.toString=function(){var e=[];_.forOwn(this.indexes,function(t){e.push(t.toString())});return"jsObjDB (nitems:"+this._count+", primkey:"+this.prim_key+", indexes:"+e.join(",")};jsObjDB.prototype.addDelegate=function(e,t,n){if(n){this.delegates.push({id:e,fn:_.bind(t,n)})}else{this.delegates.push({id:e,fn:t})}};jsObjDB.prototype.removeDelegate=function(e){_.remove(this.delegates,function(t){return t.id===e})};jsObjDB.prototype.callDelegates=function(e){_.each(this.delegates,function(t){if(this.async){setTimeout(function(){t.fn(e)},0)}else{t.fn(e)}},this)};jsObjDB.prototype.addIndex=function(e,t,n){t=t===undefined?false:t;n=n===undefined?false:n;if(typeof e!=="string"){throw"Property name must be provided and be a string"}if(_.has(this.indexes,e)){throw"Duplicate index on "+e}var r=new ObjIndex(e,t,n);var i=true;var s=_.every(this.store,function(e,t){try{r.addItem(e);return true}catch(n){return false}});if(s){this.indexes[e]=r;return true}else{throw"Unable to create index - bad or duplicate value"}};jsObjDB.prototype.removeIndex=function(e){if(!_.has(this.indexes,e)){throw"Deleting a non-existent index ("+e+")"}delete this.indexes[e]};jsObjDB.prototype.insert=function(e,t,n){if(!jsObjDB.arrayOrCursor(e)){throw"insert requires an array of objects"}var r=new Cursor(this);var i=new Cursor;var s=e.length;for(var o=0;o<s;o++){try{this._insertOne(e[o]);r.push(e[o])}catch(u){i.push(e[o])}}var a={type:"insert",inserted:r,failed:i};if(t){n=n||this;var f=_.bind(t,n);f(a)}this.callDelegates(a);return a};jsObjDB.prototype.insertOne=function(e,t,n){if(jsObjDB.arrayOrCursor(e)){throw"insertOne requires a single object"}this._insertOne(e);var r={type:"insert",inserted:new Cursor(this),failed:new Cursor};r.inserted.push(e);if(t){n=n||this;var i=_.bind(t,n);i(r)}this.callDelegates(r);return e};jsObjDB.prototype._insertOne=function(e){if(_.has(e,"_id")){throw"Cannot insert with _id field"}e._id=this.ref_id++;try{_.each(this.indexes,function(t,n){t.addItem(e)},this);this.store[e._id]=e}catch(t){_.each(this.indexes,function(t,n){t.removeItem(e)},this);delete this.store[e._id];throw t}this._count++;return e};jsObjDB.prototype.upsertOne=function(e,t,n){if(jsObjDB.arrayOrCursor(e)){throw"UpsertOne requires a single object"}var r=this._upsertOne(e);var i=r[0];var e=r[1];var s={type:"upsert",inserted:new Cursor(this),updated:new Cursor(this),failed:new Cursor};if(i==="insert"){s.inserted.push(e)}else{s.updated.push(e)}if(t){n=n||this;var o=_.bind(t,n);o(s)}this.callDelegates(s);return e};jsObjDB.prototype.upsert=function(e,t,n){if(!jsObjDB.arrayOrCursor(e)){throw"Upsert requires an array of items"}var r=new Cursor(this);var i=new Cursor(this);var s=new Cursor;var o=e.length;for(var u=0;u<o;u++){var a=e[u];try{var f=this._upsertOne(a);var l=f[0];a=f[1];if(l==="insert"){r.push(a)}else{i.push(a)}}catch(c){s.push(a)}}var h={type:"upsert",inserted:r,updated:i,failed:s};if(t){n=n||this;var p=_.bind(t,n);p(h)}this.callDelegates(h);return h};jsObjDB.prototype._upsertOne=function(e){var t=undefined;if(_.has(e,"_id")){t=this.store[e._id]}else{if(!this.prim_key||!_.has(e,this.prim_key)){throw"Primary key on DB and item property is required for upserts (unless _id is provided)"}var n=this.indexes[this.prim_key].find(e[this.prim_key]);if(n){if(n.length>0){t=n[0]}}}if(t){var r=jsObjDB.parseChanges(e);return["update",this._updateOne(t,r)]}else{return["insert",this._insertOne(e)]}};jsObjDB.prototype.update=function(e,t,n,r){var i=jsObjDB.parseChanges(t);var s=this.find(e);var o=new Cursor(this);var u=new Cursor(this);var a=s.length;for(var f=0;f<a;f++){var l=s[f];try{var c=this._updateOne(l,i);o.push(c)}catch(h){u.push(l)}}var p={type:"update",updated:o,failed:u};if(n){r=r||this;var d=_.bind(n,r);d(p)}this.callDelegates(p);return p};jsObjDB.prototype._updateOne=function(e,t){var n=_.cloneDeep(e);_.forOwn(this.indexes,function(t){t.removeItem(e)},this);try{jsObjDB.doChanges(e,t)}catch(r){}try{_.forOwn(this.indexes,function(t){t.addItem(e)},this)}catch(r){_.forOwn(this.indexes,function(t){t.removeItem(e)},this);this.store[n._id]=n;_.forOwn(this.indexes,function(e,t){e.addItem(n)},this);throw"Update caused indexing failure"}return e};jsObjDB.prototype.delete=function(e,t,n){e=e||{};var r=this.find(e);var i=r.length;for(var s=0;s<i;s++){var o=r[s];delete this.store[o._id];this._count--;_.forOwn(this.indexes,function(e){e.removeItem(o)},this)}var u={type:"delete",deleted:r};if(t){n=n||this;var a=_.bind(t,n);a(u)}this.callDelegates(u);return u};jsObjDB.prototype._chooseIndex=function(e){var t=_.max(e,function(e){var t=e[0];var n=e[1];if(n!=="$eq"&&n!=="$in"&&n!=="$contains"){return 0}var r=this.indexes[t];if(r===undefined){return 0}else{return r.partitions}},this);var n=t[0];var r=t[1];if(!_.has(this.indexes,n)){return null}if(r!=="$eq"&&r!=="$in"&&r!=="$contains"){return null}return t};jsObjDB.prototype.count=function(e){if(!e||e==={}){return this._count}e=e||{};var t=this.find(e);return t.length};jsObjDB.prototype.find=function(e,t,n){e=e||{};var r=this.store;var i=this;var s=jsObjDB.parseQuery(e);var o=this._chooseIndex(s);if(o){s=_.without(s,o);var u=o[0],a=o[1],f=o[2];if(a==="$eq"||a==="$contains"){r=this.indexes[u].find(f)}else if(a==="$in"){r=_.reduce(f,function(e,t){e=_.union(e,this.indexes[u].find(t));return e},[],this)}else{throw"Invalid op index type"}}r=_.filter(r,function(e){return jsObjDB.doQueryMatching(e,s)},this);var l=new Cursor(this,r);if(t){n=n||this;var c=_.bind(t,n);c(l)}return l};jsObjDB.prototype.findOne=function(e,t,n){var r=this.store;var i=jsObjDB.parseQuery(e);var s=this._chooseIndex(i);if(s){i=_.without(i,s);var o=s[0],u=s[1],a=s[2];if(u==="$eq"||u==="$contains"){r=this.indexes[o].find(a)}else if(u==="$in"){r=_.reduce(a,function(e,t){e=_.union(e,this.indexes[o].find(t))},[],this)}else{throw"Invalid op index type"}}if(i.length>0){var f=_.find(r,function(e){var t=jsObjDB.doQueryMatching(e,i);return t},this);if(f===undefined){r=[]}else{r=[f]}}var l=null;if(r&&r.length>0){l=r[0]}if(t){n=n||this;var c=_.bind(t,n);c(l)}return l};jsObjDB.prototype.findWhere=function(e,t){if(!e){throw"Test function is required"}t=t||this;var n=_.bind(e,t);var r=new Cursor(this,_.filter(this.store,n));return r};jsObjDB.prototype.exists=function(e){return this.findOne(e)!==null};jsObjDB.parseQuery=function(e){var t=[];_.forOwn(e,function(e,n){if(typeof e==="object"){_.forOwn(e,function(e,r){t.push([n,r,e])})}else{t.push([n,"$eq",e])}});return t};jsObjDB.parseChanges=function(e){var t=[];_.forOwn(e,function(e,n){if(typeof e==="object"){_.forOwn(e,function(e,r){t.push([n,r,e])})}else{t.push([n,"$set",e])}});return t};jsObjDB.doChanges=function(e,t){_.each(t,function(t){var n=t[0],r=t[1],i=t[2];switch(r){case"$set":e[n]=i;break;case"$inc":e[n]=_.has(e,n)?e[n]+i:i;break;case"$dec":e[n]=_.has(e,n)?e[n]-i:-i;break;case"$push":if(!_.has(e,n)){e[n]=[]}else{if(!_.isArray(e[n])){throw"Object is not an array. "+e._ref}}e[n].push(i);break;case"$concat":if(!_.has(e,n)){e[n]=[]}else{if(!_.isArray(e[n])){throw"Object is not an array. "+e._ref}}if(!_.isArray(i)){throw"Value is not an array. "+i}e[n]=e[n].concat(i);break;case"$setadd":if(!_.has(e,n)){e[n]=[]}else{if(!_.isArray(e[n])){throw"Object is not an array. "+e._ref}}e[n]=_.union(e[n],[i]);break;case"$pop":if(!_.has(e,n)){e[n]=[]}else{if(!_.isArray(e[n])){throw"Object is not an array. "+e._ref}}if(i>0){e[n]=_.initial(e[n],i)}else{e[n]=_.rest(e[n],-i)}break;case"$pull":if(!_.has(e,n)){e[n]=[]}else{if(!_.isArray(e[n])){throw"Object is not an array. "+e._ref}}if(_.isArray(i)){e[n]=_.difference(e[n],i)}else{_.pull(e[n],i)}break;default:throw"Back operator in update: "+r}})};jsObjDB.arrayOrCursor=function(e){return e&&typeof e.length=="number"};jsObjDB.getPropertyValue=function(e,t){if(!e||!t){return undefined}var n=t.split(".");var r=e;var i=n.length;for(var s=0;s<i;s++){if(r===undefined){return undefined}var o=n[s];var u=/([a-z0-9_]+)\[([a-z0-9_]+)\]/;var a=u.exec(o);if(a!=null){var f=a[1];var l=a[2];if(!_.has(r,f)){return undefined}if(!_.isArray(r[f])){return undefined}r=r[f][l]}else{if(!_.has(r,o)){return undefined}r=r[o]}}return r};jsObjDB.doQueryMatching=function(e,t){if(t.length===0){return true}return _.every(t,function(t){var n=t[0],r=t[1],i=t[2];var s=jsObjDB.getPropertyValue(e,n);if(s===undefined){return false}switch(r){case"$eq":return s===i;case"$ne":return s!==i;case"$lt":return s<i;case"$gt":return s>i;case"$le":return s<=i;case"$ge":return s>=i;case"$in":if(!_.isArray(i)){throw"Must provide array for in operator"}return i.indexOf(s)>=0;case"$nin":if(!_.isArray(i)){throw"Must provide array for nin operator"}return i.indexOf(s)===-1;case"$match":return(new RegExp(i)).test(s);case"$contains":if(!_.isArray(s))throw"Contains operator only for arrays";return s.indexOf(i)>=0;default:return false}},this)};jsObjDB.sizeOfObject=function(e){var t=[e];var n=0;for(var r=0;r<t.length;r++){var i=t[r];switch(typeof i){case"boolean":n+=4;break;case"number":n+=8;break;case"string":n+=2*i.length;break;case"object":if(i&&typeof i.sizeof==="function"){n+=i.sizeof()}else{if(Object.prototype.toString.call(i)!="[object Array]"){for(var s in i)n+=2*s.length}for(var s in i){var o=false;for(var u=0;u<t.length;u++){if(t[u]===t[r][s]){o=true;break}}if(!o)t.push(i[s])}}}}return n};if(is_node){module.exports=jsObjDB}